<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù - Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="bar.css">
  <style>
    :root {
      --primary: #f97316;
      --primary-dark: #ea580c;
      --secondary: #059669;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border: #e5e7eb;
      --success: #059669;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --waiting: #8b5cf6;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }
    body {
      background-color: #f3f4f6;
      color: var(--dark);
      direction: rtl;
      text-align: right;
    }
    .container {
      display: flex;
      min-height: 100vh;
      margin-right: 0;
    }
    .nav-links {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .nav-item {
      margin: 0;
    }
    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: #d1d5db;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border-right: 3px solid transparent;
    }
    .nav-link:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }
    .nav-link.active {
      background: rgba(249, 115, 22, 0.1);
      color: var(--primary);
      border-right: 3px solid var(--primary);
    }
    .nav-link i {
      margin-left: 0.75rem;
      font-size: 1.1rem;
      width: 24px;
      text-align: center;
    }
    .logout-btn {
      margin-top: auto;
      padding: 1rem 1.5rem;
      background: rgba(255,255,255,0.05);
      color: #f87171;
      border: none;
      border-radius: 0;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      text-align: right;
      display: flex;
      align-items: center;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .logout-btn i {
      margin-left: 0.75rem;
    }
    /* Main Content Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
      transition: all 0.3s ease;
      border-top: 4px solid var(--primary);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .stat-card.delivered {
      border-top-color: var(--success);
    }
    .stat-card.pending {
      border-top-color: var(--warning);
    }
    .stat-card.waiting {
      border-top-color: var(--waiting);
    }
    .stat-card.in-transit {
      border-top-color: #0ea5e9;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      margin: 0.5rem 0;
      color: var(--dark);
    }
    .stat-label {
      font-size: 1rem;
      color: var(--gray);
      font-weight: 500;
    }
    .controls {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .filter-btn {
      padding: 0.7rem 1.5rem;
      border-radius: 0.8rem;
      border: 2px solid var(--border);
      background: white;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .search-container {
      flex: 1;
      max-width: 400px;
      position: relative;
    }
    .search-container input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 3rem;
      border-radius: 0.8rem;
      border: 2px solid var(--border);
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    .search-container input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .search-container i {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    .orders-table-container {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 1.2rem;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }
    th {
      background-color: #f9fafb;
      font-weight: 700;
      color: var(--dark);
      position: sticky;
      top: 0;
    }
    .order-row:hover {
      background-color: #fdf2f8;
    }
    .select-field, .input-field {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.5rem;
      border: 2px solid var(--border);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    .select-field:focus, .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .details-btn, .transfer-btn, .deliver-btn, .reassign-btn, .delete-btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .details-btn {
      background: var(--info);
      color: white;
    }
    .details-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    .transfer-btn.enabled, .deliver-btn.enabled, .reassign-btn.enabled {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }
    .transfer-btn.enabled:hover, .deliver-btn.enabled:hover, .reassign-btn.enabled:hover {
      background: linear-gradient(135deg, var(--primary-dark), #dc2626);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
    }
    .transfer-btn.disabled, .deliver-btn.disabled, .reassign-btn.disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .delete-btn {
      background-color: #ef4444;
      color: white;
    }
    .delete-btn:hover {
      background-color: #dc2626;
      transform: translateY(-2px);
    }
    .loading-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
      font-size: 1.1rem;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      animation: modalAppear 0.3s ease-out;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--dark);
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: color 0.2s;
    }
    .close-modal:hover {
      color: var(--dark);
    }
    .modal-body {
      padding: 1.5rem;
    }
    .logout-btn-header {
      padding: 0.7rem 1.5rem;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logout-btn-header:hover {
      background: white;
      color: var(--primary);
    }
    .captain-select-container {
      position: relative;
      min-width: 200px;
    }
    .captain-select {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      background: white;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .captain-select:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .captain-select:disabled {
      background: #f9fafb;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .captain-info {
      margin-top: 0.5rem;
      animation: fadeIn 0.3s ease;
    }
    .captain-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      background: #059669;
      color: white;
    }
    .captain-badge.success {
      background: linear-gradient(135deg, #059669, #047857);
    }
    .captain-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .captain-name {
      color: #374151;
    }
    .captain-assigned-badge {
      color: #059669;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes slideUp {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      padding: 1rem 2rem;
      border-radius: 0.8rem;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease-out;
    }
    .notification-success {
      background: linear-gradient(135deg, #059669, #047857);
    }
    .notification-error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    .notification-info {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    .new-order {
      background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent);
      border-left: 4px solid #f97316;
      animation: highlightNew 2s ease-in-out;
    }
    @keyframes highlightNew {
      0% { background: rgba(249, 115, 22, 0.3); }
      100% { background: rgba(249, 115, 22, 0.1); }
    }
    .notification-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem;
      text-align: center;
      z-index: 5000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .notification-bar.show {
      transform: translateY(0);
    }
    .notification-bar-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    .notification-bar i {
      font-size: 1.5rem;
    }
    .notification-bar-close {
      position: absolute;
      left: 1rem;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .controls {
        flex-direction: column;
      }
      .search-container {
        max-width: 100%;
      }
      th, td {
        padding: 0.8rem 0.5rem;
        font-size: 0.9rem;
      }
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-right: 0;
        margin-top: 0;
      }
      .captain-select-container {
        min-width: 150px;
      }
      .captain-select {
        font-size: 0.8rem;
        padding: 0.4rem;
      }
      .captain-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }
      .transfer-btn.enabled,
      .transfer-btn.disabled,
      .deliver-btn.enabled,
      .deliver-btn.disabled,
      .reassign-btn.enabled,
      .reassign-btn.disabled,
      .delete-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .filter-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Bar -->
  <div class="notification-bar" id="notification-bar">
    <div class="notification-bar-content">
      <i class="fas fa-bell"></i>
      <span id="notification-message">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
    </div>
    <button class="notification-bar-close" onclick="closeNotificationBar()">&times;</button>
  </div>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&h=400&fit=crop&crop=center" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨">
        <h2>Ø§Ù„Ù…ÙƒØªØ¨</h2>
      </div>
      <a class="nav-link active" href="./dashboard.html">
        <i class="fas fa-tachometer-alt"></i>
        <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
      </a>
      <a class="nav-link" href="./add-order.html">
        <i class="fas fa-plus-circle"></i>
        <span>Ø§Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠØ§</span>
      </a>
      <a class="nav-link" href="./customers.html">
        <i class="fas fa-users"></i>
        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
      </a>
      <a class="nav-link" href="./covenant.html">
        <i class="fas fa-users"></i>
        <span>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø© </span>
      </a>
      <a class="nav-link" href="./captain-preformans.html">
        <i class="fas fa-chart-line"></i>
        <span>Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙƒØ¨Ø§ØªÙ†</span>
      </a>
      <a class="nav-link" href="./history-mange.html">
        <i class="fas fa-history"></i>
        <span>Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
      </a>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <div>
          <h1><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù</h1>
          <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨ÙƒÙØ§Ø¡Ø© ÙˆØ³Ù‡ÙˆÙ„Ø©</p>
        </div>
        <button class="logout-btn-header" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-shopping-cart fa-2x"></i>
          <div class="stat-value" id="total-orders">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        </div>
        <div class="stat-card delivered">
          <i class="fas fa-check-circle fa-2x"></i>
          <div class="stat-value" id="delivered">0</div>
          <div class="stat-label">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        </div>
        <div class="stat-card pending">
          <i class="fas fa-clock fa-2x"></i>
          <div class="stat-value" id="pending">0</div>
          <div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹</div>
        </div>
        <div class="stat-card waiting">
          <i class="fas fa-box fa-2x"></i>
          <div class="stat-value" id="waiting-delivery">0</div>
          <div class="stat-label">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
        </div>
        <div class="stat-card in-transit">
          <i class="fas fa-truck-moving fa-2x"></i>
          <div class="stat-value" id="in-transit">0</div>
          <div class="stat-label">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        </div>
      </div>
      <div class="controls">
        <button class="filter-btn" data-status="all" onclick="setFilterStatus('all')">
          <i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </button>
        <button class="filter-btn active" data-status="Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹" onclick="setFilterStatus('Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹')">
          <i class="fas fa-clock"></i> Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹ <span id="orders-count-pending">(0)</span>
        </button>
        <button class="filter-btn" data-status="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…" onclick="setFilterStatus('ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…')">
          <i class="fas fa-box"></i> ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…
        </button>
        <button class="filter-btn" data-status="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„" onclick="setFilterStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„')">
          <i class="fas fa-truck-moving"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„
        </button>
        <button class="filter-btn" data-status="ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„" onclick="setFilterStatus('ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„')">
          <i class="fas fa-check"></i> ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„
        </button>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." oninput="handleSearch()">
        </div>
      </div>
      <div class="orders-table-container">
        <table>
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</th>
              <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</th>
              <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
              <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="orders-body">
            <tr>
              <td colspan="8" class="loading-state">
                <div class="loading-spinner"></div>
                Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Modal for order details -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-details">
        <!-- Order details will be loaded here -->
      </div>
    </div>
  </div>
  <!-- Hidden audio element for notifications -->
  <audio id="notification-sound" src="notification.mp3.mp3" preload="auto"></audio>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://vrngqopmdvdmdayswlos.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZybmdxb3BtZHZkbWRheXN3bG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4ODYwMDgsImV4cCI6MjA2NzQ2MjAwOH0.bDwUJkyiQfv1egMgYy-hrj8pJMGTHAeQYBdp0z4CMrs'
    );
    let currentStatusFilter = "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹";
    let currentSearchText = "";
    let latestOrderIds = new Set();
    let allOrders = [];
    let displayedOrders = [];
    let captains = [];
    let restaurants = [];
    const alertSound = document.getElementById("notification-sound");
    let audioContext;
    let audioAllowed = false;
    let autoRefreshInterval;
    let lastNotificationTime = 0;
    let notificationTimeout;
    let pendingOrdersCheckInterval;
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        filter: params.get('filter') || "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹",
        search: params.get('search') || ""
      };
    }
    function updateUrlParams(filter, search) {
      const url = new URL(window.location);
      url.searchParams.set('filter', filter);
      if (search) {
        url.searchParams.set('search', search);
      } else {
        url.searchParams.delete('search');
      }
      window.history.replaceState({}, '', url);
    }
    async function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = audioContext.createBuffer(1, 1, 22050);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start();
        await audioContext.resume();
        audioAllowed = true;
        console.log("âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ… Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.warn("âŒ Ø±ÙØ¶ Ø§Ù„Ù…ØªØµÙØ­ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err.message);
      }
    }
    document.addEventListener("click", initAudio, { once: true });
    document.addEventListener("click", (e) => {
      if (e.target.closest(".order-row button, .order-row select, .order-row input")) {
        if (alertSound) {
          alertSound.pause();
          alertSound.currentTime = 0;
        }
      }
    });
    window.setFilterStatus = function (status) {
      currentStatusFilter = status;
      console.log(`ğŸ”„ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ± Ø¥Ù„Ù‰: ${status}`);
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
          btn.classList.add('active');
        }
      });
      updateUrlParams(status, currentSearchText);
      fetchOrdersByStatus(status);
    }
    window.handleSearch = function () {
      const searchInput = document.getElementById("searchInput");
      currentSearchText = searchInput ? searchInput.value.trim() : "";
      console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø«: "${currentSearchText}"`);
      updateUrlParams(currentStatusFilter, currentSearchText);
      fetchOrdersByStatus(currentStatusFilter);
    }
    async function loadInitialData() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          window.location.href = './index.html';
          return;
        }
        console.log("âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡");
        const urlParams = getUrlParams();
        currentStatusFilter = urlParams.filter;
        currentSearchText = urlParams.search;
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.status === currentStatusFilter) {
            btn.classList.add('active');
          }
        });
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.value = currentSearchText;
        }
        await Promise.all([
          loadCaptains(),
          loadRestaurants()
        ]);
        console.log(`ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${captains.length} ÙƒØ§Ø¨ØªÙ† Ùˆ ${restaurants.length} Ù…Ø·Ø¹Ù…`);
        await Promise.all([
          loadStatistics(),
          fetchOrdersByStatus(currentStatusFilter)
        ]);
        console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©");
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
      }
    }
    async function loadCaptains() {
      try {
        console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†...");
        const { data, error } = await supabase
          .from("users")
          .select("id, full_name")
          .eq("role", "captain");
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†:', error);
          captains = [];
          showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†: ' + error.message);
        } else {
          captains = data || [];
          console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${captains.length} ÙƒØ§Ø¨ØªÙ†:`, captains);
          if (captains.length === 0) {
            console.warn("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            showError('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ÙƒØ¨Ø§ØªÙ† Ø£ÙˆÙ„Ø§Ù‹.');
          }
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†:', error);
        captains = [];
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†: ' + error.message);
      }
    }
    async function loadRestaurants() {
      try {
        const { data, error } = await supabase
          .from("users")
          .select("id, full_name")
          .eq("role", "restaurant");
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…:', error);
          restaurants = [];
        } else {
          restaurants = data || [];
          console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${restaurants.length} Ù…Ø·Ø¹Ù…`);
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…:', error);
        restaurants = [];
      }
    }
    async function loadStatistics() {
      try {
        console.log("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...");
        const [totalResult, deliveredResult, pendingResult, waitingDeliveryResult, inTransitResult] = await Promise.all([
          supabase.from("orders").select("id", { count: 'exact', head: true }),
          supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„"),
          supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹"),
          supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…"),
          supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„")
        ]);
        const stats = {
          total: totalResult.count || 0,
          delivered: deliveredResult.count || 0,
          pending: pendingResult.count || 0,
          waitingDelivery: waitingDeliveryResult.count || 0,
          inTransit: inTransitResult.count || 0
        };
        updateStatisticsDisplay(stats);
        console.log("ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø­Ø¯Ø«Ø©:", stats);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
      }
    }
    function updateStatisticsDisplay(stats) {
      const totalOrdersEl = document.getElementById("total-orders");
      const deliveredEl = document.getElementById("delivered");
      const pendingEl = document.getElementById("pending");
      const waitingDeliveryEl = document.getElementById("waiting-delivery");
      const inTransitEl = document.getElementById("in-transit");
      if (totalOrdersEl) totalOrdersEl.textContent = stats.total;
      if (deliveredEl) deliveredEl.textContent = stats.delivered;
      if (pendingEl) pendingEl.textContent = stats.pending;
      if (waitingDeliveryEl) waitingDeliveryEl.textContent = stats.waitingDelivery;
      if (inTransitEl) inTransitEl.textContent = stats.inTransit;
    }
    async function fetchOrdersByStatus(status) {
      try {
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø­Ø§Ù„Ø©: ${status}`);
        showLoadingState();
        let query = supabase
          .from("orders")
          .select(`
            id,
            custom_name,
            custom_phone,
            custom_address,
            restaurant_id,
            captain_id,
            status,
            order_price,
            service_price,
            commission_percent,
            notes,
            created_at
          `)
          .order("created_at", { ascending: false });
        if (status !== "all") {
          query = query.eq("status", status);
        }
        const { data: orders, error } = await query;
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', error);
          throw error;
        }
        let filteredOrders = orders || [];
        if (currentSearchText) {
          filteredOrders = filteredOrders.filter(order => {
            const restaurant = restaurants.find(r => r.id === order.restaurant_id);
            const captain = captains.find(c => c.id === order.captain_id);
            const searchLower = currentSearchText.toLowerCase();
            return (
              (order.custom_name && order.custom_name.toLowerCase().includes(searchLower)) ||
              (order.custom_phone && order.custom_phone.includes(currentSearchText)) ||
              (order.custom_address && order.custom_address.toLowerCase().includes(searchLower)) ||
              (restaurant?.full_name && restaurant.full_name.toLowerCase().includes(searchLower)) ||
              (captain?.full_name && captain.full_name.toLowerCase().includes(searchLower))
            );
          });
        }
        displayedOrders = filteredOrders;
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${filteredOrders.length} Ø·Ù„Ø¨ Ù„Ù„Ø­Ø§Ù„Ø©: ${status}`);
        displayOrders(filteredOrders);
        updateOrdersCount(filteredOrders.length);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ' + error.message);
        showErrorState(error.message);
      }
    }
    function showLoadingState() {
      const tbody = document.getElementById("orders-body");
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-state">
              <div class="loading-spinner"></div>
              Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...
            </td>
          </tr>
        `;
      }
    }
    function showErrorState(errorMessage) {
      const tbody = document.getElementById("orders-body");
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-state" style="color: #ef4444;">
              âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${errorMessage}
              <br>
              <button onclick="fetchOrdersByStatus('${currentStatusFilter}')" 
                      style="margin-top: 1rem; padding: 0.5rem 1rem; background: #f97316; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
              </button>
            </td>
          </tr>
        `;
      }
    }
    function updateOrdersCount(count) {
      const ordersCountEl = document.getElementById("orders-count-pending");
      if (ordersCountEl) {
        ordersCountEl.textContent = `(${count})`;
      }
    }
    function generateCaptainOptions(selectedCaptainId) {
      if (!captains || captains.length === 0) {
        return '<option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† Ù…ØªØ§Ø­Ø©</option>';
      }
      return captains.map(captain => {
        const isSelected = selectedCaptainId === captain.id;
        return `<option value="${captain.id}" ${isSelected ? 'selected' : ''} data-captain-name="${captain.full_name}">
          ${captain.full_name}
        </option>`;
      }).join('');
    }
    window.handleCaptainChange = async function(orderId, captainId) {
      const transferBtn = document.getElementById(`transfer-btn-${orderId}`);
      const reassignBtn = document.getElementById(`reassign-btn-${orderId}`);
      const captainInfo = document.getElementById(`captain-info-${orderId}`);
      const captainSelect = document.getElementById(`captain-select-${orderId}`);
      try {
        if (captainSelect) {
          captainSelect.disabled = true;
          captainSelect.style.opacity = '0.6';
        }
        if (captainId) {
          const { error } = await supabase
            .from("orders")
            .update({ captain_id: captainId })
            .eq("id", orderId);
          if (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†:', error);
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†');
            if (captainSelect) {
              captainSelect.value = "";
            }
            return;
          }
          const selectedCaptain = captains.find(c => c.id === captainId);
          const captainName = selectedCaptain ? selectedCaptain.full_name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          if (transferBtn) {
            transferBtn.disabled = false;
            transferBtn.className = 'transfer-btn enabled';
            transferBtn.textContent = 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
          }
          if (reassignBtn) {
            reassignBtn.disabled = false;
            reassignBtn.className = 'reassign-btn enabled';
            reassignBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†';
          }
          if (captainInfo) {
            captainInfo.innerHTML = `
              <span class="captain-badge success">
                âœ“ ØªÙ… ØªØ¹ÙŠÙŠÙ†: ${captainName}
              </span>
            `;
            captainInfo.style.display = 'block';
          } else {
            const captainContainer = captainSelect.closest('.captain-select-container');
            if (captainContainer) {
              const newCaptainInfo = document.createElement('div');
              newCaptainInfo.className = 'captain-info';
              newCaptainInfo.id = `captain-info-${orderId}`;
              newCaptainInfo.innerHTML = `
                <span class="captain-badge success">
                  âœ“ ØªÙ… ØªØ¹ÙŠÙŠÙ†: ${captainName}
                </span>
              `;
              captainContainer.appendChild(newCaptainInfo);
            }
          }
          showSuccess(`ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ† "${captainName}" Ø¨Ù†Ø¬Ø§Ø­`);
          const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
          if (orderIndex !== -1) {
            displayedOrders[orderIndex].captain_id = captainId;
          }
        } else {
          const { error } = await supabase
            .from("orders")
            .update({ captain_id: null })
            .eq("id", orderId);
          if (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†:', error);
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†');
            return;
          }
          if (transferBtn) {
            transferBtn.disabled = true;
            transferBtn.className = 'transfer-btn disabled';
            transferBtn.textContent = 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ†';
          }
          if (reassignBtn) {
            reassignBtn.disabled = true;
            reassignBtn.className = 'reassign-btn disabled';
            reassignBtn.textContent = 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ†';
          }
          if (captainInfo) {
            captainInfo.style.display = 'none';
          }
          showSuccess('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†');
          const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
          if (orderIndex !== -1) {
            displayedOrders[orderIndex].captain_id = null;
          }
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙƒØ§Ø¨ØªÙ†:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + error.message);
      } finally {
        if (captainSelect) {
          captainSelect.disabled = false;
          captainSelect.style.opacity = '1';
        }
      }
    }
    function displayOrders(orders) {
      const tbody = document.getElementById("orders-body");
      if (!tbody) return;
      if (!orders || orders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-state">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§
            </td>
          </tr>
        `;
        return;
      }
      tbody.innerHTML = "";
      orders.forEach((order) => {
        try {
          const restaurant = restaurants.find(r => r.id === order.restaurant_id);
          const row = document.createElement("tr");
          row.classList.add("order-row");
          row.dataset.orderId = order.id;
          if (order.status === "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹") {
            row.innerHTML = `
              <td>
                <strong>${restaurant?.full_name || "Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</strong>
              </td>
              <td>
                <input
                  type="text"
                  class="input-field"
                  value="${order.custom_address || ""}"
                  onchange="updateAddress('${order.id}', this.value)"
                  placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„"
                />
              </td>
              <td>
                <span style="color: #059669; font-weight: 600;">
                  ${order.order_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <span style="color: #f97316; font-weight: 600;">
                  ${order.service_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <div class="captain-select-container">
                  <select class="select-field captain-select" id="captain-select-${order.id}" onchange="handleCaptainChange('${order.id}', this.value)">
                    <option value="" ${!order.captain_id ? 'selected' : ''}>
                      ${captains.length > 0 ? 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ† Ù„Ù„ØªÙˆØµÙŠÙ„' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† Ù…ØªØ§Ø­Ø©'}
                    </option>
                    ${generateCaptainOptions(order.captain_id)}
                  </select>
                  ${order.captain_id ? `
                    <div class="captain-info" id="captain-info-${order.id}">
                      <span class="captain-badge success">âœ“ ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†</span>
                    </div>
                  ` : ''}
                </div>
              </td>
              <td>
                <span style="font-weight: 600; color: #374151;">
                  20%
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button class="transfer-btn ${!order.captain_id || captains.length === 0 ? 'disabled' : 'enabled'}"
                          onclick="transferOrder('${order.id}', this)"
                          id="transfer-btn-${order.id}"
                          ${!order.captain_id || captains.length === 0 ? 'disabled' : ''}>
                    ${!order.captain_id ? 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ†' : 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨'}
                  </button>
                  <button class="details-btn" onclick='showOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})'>
                    ØªÙØ§ØµÙŠÙ„
                  </button>
                </div>
              </td>
              <td>
                 <button class="delete-btn" onclick="deleteOrder('${order.id}', this)">
                    Ø­Ø°Ù
                 </button>
              </td>
            `;
          }
          else if (order.status === "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…") {
            const captain = captains.find(c => c.id === order.captain_id);
            row.innerHTML = `
              <td>
                <strong>${restaurant?.full_name || "Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</strong>
              </td>
              <td>
                <input
                  type="text"
                  class="input-field"
                  value="${order.custom_address || ""}"
                  onchange="updateAddress('${order.id}', this.value)"
                  placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„"
                />
              </td>
              <td>
                <span style="color: #059669; font-weight: 600;">
                  ${order.order_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <span style="color: #f97316; font-weight: 600;">
                  ${order.service_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <div class="captain-select-container">
                  <select class="select-field captain-select" id="captain-select-${order.id}" onchange="handleCaptainChange('${order.id}', this.value)">
                    <option value="" ${!order.captain_id ? 'selected' : ''}>
                      ${captains.length > 0 ? 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ† Ù„Ù„ØªÙˆØµÙŠÙ„' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† Ù…ØªØ§Ø­Ø©'}
                    </option>
                    ${generateCaptainOptions(order.captain_id)}
                  </select>
                  ${order.captain_id ? `
                    <div class="captain-info" id="captain-info-${order.id}">
                      <span class="captain-badge success">âœ“ ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†</span>
                    </div>
                  ` : ''}
                </div>
              </td>
              <td>
                <span style="font-weight: 600; color: #374151;">
                  20%
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button class="reassign-btn ${!order.captain_id || captains.length === 0 ? 'disabled' : 'enabled'}"
                          onclick="reassignCaptain('${order.id}', this)"
                          id="reassign-btn-${order.id}"
                          ${!order.captain_id || captains.length === 0 ? 'disabled' : ''}>
                    ${!order.captain_id ? 'Ø§Ø®ØªØ± ÙƒØ§Ø¨ØªÙ†' : 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†'}
                  </button>
                  <button class="deliver-btn enabled"
                          onclick="markAsDelivered('${order.id}', this)">
                    ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„
                  </button>
                  <button class="details-btn" onclick='showOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})'>
                    ØªÙØ§ØµÙŠÙ„
                  </button>
                </div>
              </td>
              <td>
                 <button class="delete-btn" onclick="deleteOrder('${order.id}', this)">
                    Ø­Ø°Ù
                 </button>
              </td>
            `;
          }
          else {
            const captain = captains.find(c => c.id === order.captain_id);
            const statusColor = getStatusColor(order.status);
            row.innerHTML = `
              <td>
                <strong>${restaurant?.full_name || "Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</strong>
              </td>
              <td>
                <span>${order.custom_address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</span>
              </td>
              <td>
                <span style="color: #059669; font-weight: 600;">
                  ${order.order_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <span style="color: #f97316; font-weight: 600;">
                  ${order.service_price || 0} Ø¬.Ù…
                </span>
              </td>
              <td>
                <div class="captain-display">
                  <span class="captain-name" style="font-weight: 600;">
                    ${captain?.full_name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}
                  </span>
                  ${captain ? '<span class="captain-assigned-badge">âœ“</span>' : ''}
                </div>
              </td>
              <td>
                <span style="font-weight: 600; color: #374151;">
                  20%
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                  <span style="color: ${statusColor}; font-weight: 600; padding: 0.4rem 0.8rem; background: ${statusColor}15; border-radius: 0.5rem; font-size: 0.85rem;">
                    ${order.status}
                  </span>
                  <button class="details-btn" onclick='showOrderDetails(${JSON.stringify(order).replace(/'/g, "&#39;")})' style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                    ØªÙØ§ØµÙŠÙ„
                  </button>
                </div>
              </td>
              <td>
                 <button class="delete-btn" onclick="deleteOrder('${order.id}', this)">
                    Ø­Ø°Ù
                 </button>
              </td>
            `;
          }
          tbody.appendChild(row);
        } catch (error) {
          console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ ${order.id}:`, error);
        }
      });
    }
    window.showOrderDetails = function (order) {
      try {
        const restaurant = restaurants.find(r => r.id === order.restaurant_id);
        const captain = captains.find(c => c.id === order.captain_id);
        const html = `
          <div style="text-align: right; line-height: 2;">
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.custom_name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.custom_phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
            <p><strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${order.custom_address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…:</strong> ${restaurant?.full_name || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
            <p><strong>Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ù…ÙØ¹ÙŠÙÙ‘Ù†:</strong> ${captain?.full_name || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ø¹Ø¯"}</p>
            <p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</strong>
              <span style="color: ${getStatusColor(order.status)}; font-weight: 600;">
                ${order.status || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}
              </span>
            </p>
            <p><strong>Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨:</strong>
              <span style="color: #059669; font-weight: 600;">${order.order_price || 0} Ø¬.Ù…</span>
            </p>
            <p><strong>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„:</strong>
              <span style="color: #f97316; font-weight: 600;">${order.service_price || 0} Ø¬.Ù…</span>
            </p>
            <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>
              <span style="color: #111827; font-weight: 700; font-size: 1.1em;">
                ${(order.order_price || 0) + (order.service_price || 0)} Ø¬.Ù…
              </span>
            </p>
            <p><strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:</strong> 20%</p>
            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${order.notes || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"}</p>
            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${formatDate(order.created_at)}</p>
          </div>
        `;
        const modalDetailsEl = document.getElementById("modal-details");
        const modalEl = document.getElementById("modal");
        if (modalDetailsEl) modalDetailsEl.innerHTML = html;
        if (modalEl) modalEl.style.display = "flex";
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
      }
    }
    function getStatusColor(status) {
      const statusColors = {
        'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„': '#059669',
        'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„': '#0ea5e9',
        'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹': '#f59e0b',
        'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…': '#8b5cf6'
      };
      return statusColors[status] || '#6b7280';
    }
    function formatDate(dateString) {
      if (!dateString) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 0) {
          return `Ø§Ù„ÙŠÙˆÙ…ØŒ ${date.toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
          })}`;
        } else if (diffDays === 1) {
          return `Ø£Ù…Ø³ØŒ ${date.toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
          })}`;
        } else {
          return date.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
        return "ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­";
      }
    }
    window.closeModal = function () {
      const modalEl = document.getElementById("modal");
      if (modalEl) modalEl.style.display = "none";
    }
    const modalEl = document.getElementById("modal");
    if (modalEl) {
      modalEl.addEventListener("click", function (e) {
        if (e.target === this) {
          closeModal();
        }
      });
    }
    window.transferOrder = async function (orderId, buttonElement) {
      const captainSelect = document.getElementById(`captain-select-${orderId}`);
      const captainId = captainSelect ? captainSelect.value : null;
      if (!captainId) {
        showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒØ§Ø¨ØªÙ† Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      try {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<div class="loading-spinner" style="width: 15px; height: 15px; border-width: 2px; margin: 0 auto;"></div>';
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${orderId} Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${captainId}`);
        const { error } = await supabase
          .from("orders")
          .update({
            captain_id: captainId,
            status: "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…",
            commission_percent: 20
          })
          .eq("id", orderId);
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:', error);
          throw error;
        }
        showSuccess('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ø¨Ù†Ø¬Ø§Ø­');
        const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
          displayedOrders[orderIndex].captain_id = captainId;
          displayedOrders[orderIndex].status = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…";
          displayedOrders[orderIndex].commission_percent = 20;
        }
        await loadStatistics();
        const row = buttonElement.closest('.order-row');
        if (row) {
          row.style.transition = 'all 0.3s ease-out';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            if (row.parentNode) {
              row.parentNode.removeChild(row);
            }
            const currentCount = displayedOrders.length;
            updateOrdersCount(Math.max(0, currentCount - 1));
          }, 300);
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
        buttonElement.disabled = false;
        buttonElement.textContent = 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
      }
    }
    window.reassignCaptain = async function (orderId, buttonElement) {
      const captainSelect = document.getElementById(`captain-select-${orderId}`);
      const captainId = captainSelect ? captainSelect.value : null;
      if (!captainId) {
        showError('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙƒØ§Ø¨ØªÙ† Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      try {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<div class="loading-spinner" style="width: 15px; height: 15px; border-width: 2px; margin: 0 auto;"></div>';
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù„Ù„Ø·Ù„Ø¨ ${orderId} Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${captainId}`);
        const { error } = await supabase
          .from("orders")
          .update({
            captain_id: captainId,
            commission_percent: 20
          })
          .eq("id", orderId);
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†:', error);
          throw error;
        }
        showSuccess('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¨Ù†Ø¬Ø§Ø­');
        const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
          displayedOrders[orderIndex].captain_id = captainId;
          displayedOrders[orderIndex].commission_percent = 20;
        }
        const selectedCaptain = captains.find(c => c.id === captainId);
        if (selectedCaptain) {
          const captainInfo = document.getElementById(`captain-info-${orderId}`);
          if (captainInfo) {
            captainInfo.innerHTML = `
              <span class="captain-badge success">
                âœ“ ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†: ${selectedCaptain.full_name}
              </span>
            `;
            captainInfo.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ' + error.message);
      } finally {
        buttonElement.disabled = false;
        buttonElement.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ†';
      }
    }
    window.markAsDelivered = async function (orderId, buttonElement) {
      try {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<div class="loading-spinner" style="width: 15px; height: 15px; border-width: 2px; margin: 0 auto;"></div>';
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${orderId} Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„"`);
        const { error } = await supabase
          .from("orders")
          .update({
            status: "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„",
            commission_percent: 20
          })
          .eq("id", orderId);
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:', error);
          throw error;
        }
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„"');
        const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
          displayedOrders[orderIndex].status = "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„";
          displayedOrders[orderIndex].commission_percent = 20;
        }
        await loadStatistics();
        const row = buttonElement.closest('.order-row');
        if (row) {
          row.style.transition = 'all 0.3s ease-out';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            if (row.parentNode) {
              row.parentNode.removeChild(row);
            }
            const currentCount = displayedOrders.length;
            updateOrdersCount(Math.max(0, currentCount - 1));
          }, 300);
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
        buttonElement.disabled = false;
        buttonElement.textContent = 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„';
      }
    }
    window.updateAddress = async function (orderId, newAddress) {
      if (!newAddress || !newAddress.trim()) {
        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† ØµØ­ÙŠØ­');
        return;
      }
      try {
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø·Ù„Ø¨ ${orderId}`);
        const { error } = await supabase
          .from("orders")
          .update({
            custom_address: newAddress.trim(),
            commission_percent: 20
          })
          .eq("id", orderId);
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', error);
          throw error;
        }
        const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
          displayedOrders[orderIndex].custom_address = newAddress.trim();
          displayedOrders[orderIndex].commission_percent = 20;
        }
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ' + error.message);
      }
    }
    window.deleteOrder = async function (orderId, buttonElement) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${orderId}ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`)) {
        return;
      }
      try {
        const originalText = buttonElement.textContent;
        buttonElement.disabled = true;
        buttonElement.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
        buttonElement.style.backgroundColor = '#9ca3af';
        console.log(`ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${orderId}`);
        const { error } = await supabase
          .from("orders")
          .delete()
          .eq("id", orderId);
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨:', error);
          throw error;
        }
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        const orderIndex = displayedOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
          displayedOrders.splice(orderIndex, 1);
        }
        const allOrderIndex = allOrders.findIndex(o => o.id === orderId);
        if (allOrderIndex !== -1) {
            allOrders.splice(allOrderIndex, 1);
        }
        await loadStatistics();
        const row = buttonElement.closest('.order-row');
        if (row) {
          row.style.transition = 'all 0.3s ease-out';
          row.style.opacity = '0';
          row.style.transform = 'translateX(20px)';
          setTimeout(() => {
            if (row.parentNode) {
              row.parentNode.removeChild(row);
            }
            const currentCount = displayedOrders.length;
            updateOrdersCount(currentCount);
            console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${orderId} Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©`);
          }, 300);
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        buttonElement.disabled = false;
        buttonElement.textContent = 'Ø­Ø°Ù';
        buttonElement.style.backgroundColor = '#ef4444';
      }
    }
    function playNotificationSound() {
      if (!audioAllowed) {
        console.warn("âš ï¸ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ø¨Ø¹Ø¯");
        return;
      }
      try {
        if (alertSound) {
          alertSound.currentTime = 0;
          const playPromise = alertSound.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                console.log("ğŸ”Š ØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
              })
              .catch(error => {
                console.warn("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", error.message);
              });
          }
        } else {
          console.warn("âš ï¸ Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªÙˆÙØ±");
        }
      } catch (error) {
        console.warn("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", error.message);
      }
    }
    function showNotificationBar(message) {
      const now = Date.now();
      if (now - lastNotificationTime < 2000) {
        return;
      }
      lastNotificationTime = now;
      const notificationBar = document.getElementById('notification-bar');
      const notificationMessage = document.getElementById('notification-message');
      if (notificationMessage) {
        notificationMessage.textContent = message;
      }
      if (notificationBar) {
        notificationBar.classList.add('show');
        playNotificationSound();
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
          notificationBar.classList.remove('show');
        }, 5000);
      }
    }
    window.closeNotificationBar = function() {
      const notificationBar = document.getElementById('notification-bar');
      if (notificationBar) {
        notificationBar.classList.remove('show');
      }
    }
    function showSuccess(message) {
      showNotification(message, 'success');
    }
    function showError(message) {
      showNotification(message, 'error');
    }
    function showNotification(message, type = 'info') {
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notif => notif.remove());
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'slideUp 0.3s ease-in forwards';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }
    window.logout = async function () {
      try {
        await supabase.auth.signOut();
        window.location.href = './index.html';
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      }
    }
    async function checkForNewPendingOrders() {
      try {
        const { data: pendingOrders, error } = await supabase
          .from("orders")
          .select("id")
          .eq("status", "Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹")
          .order("created_at", { ascending: false });
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
          return;
        }
        const currentPendingOrderIds = new Set(pendingOrders.map(o => o.id));
        const hasNewPendingOrder = pendingOrders.some(order => !latestOrderIds.has(order.id));
        if (hasNewPendingOrder && latestOrderIds.size > 0) {
          showNotificationBar("Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…");
        }
        latestOrderIds = currentPendingOrderIds;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
      }
    }
    function setupAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      autoRefreshInterval = setInterval(async () => {
        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        try {
          await loadStatistics();
          const isEditing = document.activeElement.tagName === 'INPUT' ||
                           document.activeElement.tagName === 'SELECT' ||
                           document.activeElement.classList.contains('input-field') ||
                           document.activeElement.classList.contains('select-field');
          if (!isEditing) {
            await fetchOrdersByStatus(currentStatusFilter);
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
        }
      }, 10000);
      if (pendingOrdersCheckInterval) {
        clearInterval(pendingOrdersCheckInterval);
      }
      pendingOrdersCheckInterval = setInterval(async () => {
        await checkForNewPendingOrders();
      }, 5000);
      console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 10 Ø«Ø§Ù†ÙŠØ© ÙˆÙØ­Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù');
    }
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      if (pendingOrdersCheckInterval) {
        clearInterval(pendingOrdersCheckInterval);
      }
    });
    window.fetchOrdersByStatus = fetchOrdersByStatus;
    async function initializeApp() {
      try {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        await loadInitialData();
        setupAutoRefresh();
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­');
        showSuccess('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + error.message);
      }
    }
    initializeApp();
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('ğŸ“„ Ø§Ù„ØµÙØ­Ø© Ø£ØµØ¨Ø­Øª Ù…Ø±Ø¦ÙŠØ© - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        fetchOrdersByStatus(currentStatusFilter);
        loadStatistics();
      }
    });
    window.addEventListener('focus', () => {
      console.log('ğŸ” Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£ØµØ¨Ø­Øª Ù†Ø´Ø·Ø© - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
      fetchOrdersByStatus(currentStatusFilter);
      loadStatistics();
    });
  </script>  </body>
</html>