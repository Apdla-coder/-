<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم المشرف - نظام الطلبات</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="bar.css">
  <style>
    :root {
      --primary: #f97316;
      --primary-dark: #ea580c;
      --secondary: #059669;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border: #e5e7eb;
      --success: #059669;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --waiting: #8b5cf6;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }
    body {
      background-color: #f3f4f6;
      color: var(--dark);
      direction: rtl;
      text-align: right;
    }
    .container {
      display: flex;
      min-height: 100vh;
      margin-right: 0;
    }
    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: #d1d5db;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      border-right: 3px solid transparent;
    }
    .nav-link:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }
    .nav-link.active {
      background: rgba(249, 115, 22, 0.1);
      color: var(--primary);
      border-right: 3px solid var(--primary);
    }
    .nav-link i {
      margin-left: 0.75rem;
      font-size: 1.1rem;
      width: 24px;
      text-align: center;
    }
    .logout-btn {
      margin-top: auto;
      padding: 1rem 1.5rem;
      background: rgba(255,255,255,0.05);
      color: #f87171;
      border: none;
      border-radius: 0;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      text-align: right;
      display: flex;
      align-items: center;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .logout-btn i {
      margin-left: 0.75rem;
    }
    /* Main Content Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      text-align: center;
      transition: all 0.3s ease;
      border-top: 4px solid var(--primary);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .stat-card.delivered {
      border-top-color: var(--success);
    }
    .stat-card.pending {
      border-top-color: var(--warning);
    }
    .stat-card.waiting {
      border-top-color: var(--waiting);
    }
    .stat-card.in-transit {
      border-top-color: #0ea5e9;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      margin: 0.5rem 0;
      color: var(--dark);
    }
    .stat-label {
      font-size: 1rem;
      color: var(--gray);
      font-weight: 500;
    }
    .controls {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .filter-btn {
      padding: 0.7rem 1.5rem;
      border-radius: 0.8rem;
      border: 2px solid var(--border);
      background: white;
      color: var(--dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .search-container {
      flex: 1;
      max-width: 400px;
      position: relative;
    }
    .search-container input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 3rem;
      border-radius: 0.8rem;
      border: 2px solid var(--border);
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    .search-container input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .search-container i {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    .orders-table-container {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 1.2rem;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }
    th {
      background-color: #f9fafb;
      font-weight: 700;
      color: var(--dark);
      position: sticky;
      top: 0;
    }
    .order-row:hover {
      background-color: #fdf2f8;
    }
    .select-field, .input-field {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.5rem;
      border: 2px solid var(--border);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    .select-field:focus, .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .details-btn, .transfer-btn, .deliver-btn, .reassign-btn, .delete-btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .details-btn {
      background: var(--info);
      color: white;
    }
    .details-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    .transfer-btn.enabled, .deliver-btn.enabled, .reassign-btn.enabled {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }
    .transfer-btn.enabled:hover, .deliver-btn.enabled:hover, .reassign-btn.enabled:hover {
      background: linear-gradient(135deg, var(--primary-dark), #dc2626);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
    }
    .transfer-btn.disabled, .deliver-btn.disabled, .reassign-btn.disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .delete-btn {
      background-color: #ef4444;
      color: white;
    }
    .delete-btn:hover {
      background-color: #dc2626;
      transform: translateY(-2px);
    }
    .loading-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
      font-size: 1.1rem;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      animation: modalAppear 0.3s ease-out;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--dark);
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: color 0.2s;
    }
    .close-modal:hover {
      color: var(--dark);
    }
    .modal-body {
      padding: 1.5rem;
    }
    .logout-btn-header {
      padding: 0.7rem 1.5rem;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .logout-btn-header:hover {
      background: white;
      color: var(--primary);
    }
    .captain-select-container {
      position: relative;
      min-width: 200px;
    }
    .captain-select {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      background: white;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .captain-select:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .captain-select:disabled {
      background: #f9fafb;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .captain-info {
      margin-top: 0.5rem;
      animation: fadeIn 0.3s ease;
    }
    .captain-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      background: #059669;
      color: white;
    }
    .captain-badge.success {
      background: linear-gradient(135deg, #059669, #047857);
    }
    .captain-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .captain-name {
      color: #374151;
    }
    .captain-assigned-badge {
      color: #059669;
      font-weight: bold;
    }
    .notification-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem;
      text-align: center;
      z-index: 5000;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .notification-bar.show {
      transform: translateY(0);
    }
    .notification-bar-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    .notification-bar i {
      font-size: 1.5rem;
    }
    .notification-bar-close {
      position: absolute;
      left: 1rem;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
    }
    .add-order-form {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: none;
    }
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
    }
    .btn-add-order {
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add-order:hover {
      background: #047857;
      transform: translateY(-2px);
    }
    .btn-cancel {
      background: #d1d5db;
      color: var(--dark);
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 1rem;
    }
    .btn-cancel:hover {
      background: #9ca3af;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .controls {
        flex-direction: column;
      }
      .search-container {
        max-width: 100%;
      }
      th, td {
        padding: 0.8rem 0.5rem;
        font-size: 0.9rem;
      }
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-right: 0;
        margin-top: 0;
      }
      .captain-select-container {
        min-width: 150px;
      }
      .captain-select {
        font-size: 0.8rem;
        padding: 0.4rem;
      }
      .captain-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }
      .transfer-btn.enabled,
      .transfer-btn.disabled,
      .deliver-btn.enabled,
      .deliver-btn.disabled,
      .reassign-btn.enabled,
      .reassign-btn.disabled,
      .delete-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Bar -->
  <div class="notification-bar" id="notification-bar">
    <div class="notification-bar-content">
      <i class="fas fa-bell"></i>
      <span id="notification-message">طلب جديد وصل للوحة التحكم</span>
    </div>
    <button class="notification-bar-close" onclick="closeNotificationBar()">&times;</button>
  </div>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="./logo.png" alt="شعار المكتب">
        <h2>المكتب</h2>
      </div>
      <a class="nav-link active" href="./dashboard.html">
        <i class="fas fa-tachometer-alt"></i>
        <span>لوحة التحكم</span>
      </a>
      <a class="nav-link" href="./add-order.html">
        <i class="fas fa-plus-circle"></i>
        <span>اضافة طلب يدويا</span>
      </a>
      <a class="nav-link" href="./customers.html">
        <i class="fas fa-users"></i>
        <span>إدارة المستخدمين</span>
      </a>
      <a class="nav-link" href="./restaurant-management.html">
        <i class="fas fa-users"></i>
        <span>إدارة المطاعم</span>
      </a>
      <a class="nav-link" href="./covenant.html">
        <i class="fas fa-users"></i>
        <span>نظام العهدة </span>
      </a>
      <a class="nav-link" href="./captain-preformans.html">
        <i class="fas fa-chart-line"></i>
        <span>أداء الكباتن</span>
      </a>
      <a class="nav-link" href="./history-mange.html">
        <i class="fas fa-history"></i>
        <span>سجل الطلبات</span>
      </a>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>تسجيل الخروج</span>
      </button>
    </div>
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <div>
          <h1><i class="fas fa-tachometer-alt"></i> لوحة تحكم المشرف</h1>
          <p>إدارة الطلبات بكفاءة وسهولة</p>
        </div>
        <button class="logout-btn-header" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
      </div>
      <!-- زر إضافة طلب -->
      <div style="margin-bottom: 1rem;">
        <button class="filter-btn" onclick="toggleAddOrderForm()">
          <i class="fas fa-plus"></i> إضافة طلب يدويًا
        </button>
      </div>
      <!-- نموذج إضافة طلب -->
      <div class="add-order-form" id="add-order-form">
        <h3 style="margin-bottom: 1rem; color: var(--dark);">إضافة طلب جديد</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="restaurant-select">اسم المطعم</label>
            <select class="select-field" id="restaurant-select" required>
              <option value="">اختر مطعمًا</option>
            </select>
          </div>
          <div class="form-group">
            <label for="delivery-address">عنوان التوصيل</label>
            <input type="text" class="input-field" id="delivery-address" placeholder="أدخل عنوان التوصيل" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="service-price">سعر خدمة التوصيل (ج.م)</label>
            <input type="number" class="input-field" id="service-price" placeholder="مثلاً: 30" min="0" required>
          </div>
          <div class="form-group">
            <label for="commission-percent">نسبة العمولة من خدمة التوصيل (%)</label>
            <select class="select-field" id="commission-percent" required>
              <option value="20">20%</option>
              <option value="25">25%</option>
              <option value="30">30%</option>
              <option value="35">35%</option>
              <option value="40">40%</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="captain-select-new">اختيار الكابتن</label>
            <select class="select-field" id="captain-select-new" required>
              <option value="">اختر كابتن</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button class="btn-add-order" onclick="addManualOrder()">إضافة وتحويل لل delivery</button>
          <button class="btn-cancel" onclick="toggleAddOrderForm()">إلغاء</button>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-shopping-cart fa-2x"></i>
          <div class="stat-value" id="total-orders">0</div>
          <div class="stat-label">إجمالي الطلبات</div>
        </div>
        <div class="stat-card delivered">
          <i class="fas fa-check-circle fa-2x"></i>
          <div class="stat-value" id="delivered">0</div>
          <div class="stat-label">تم التوصيل</div>
        </div>
        <div class="stat-card waiting">
          <i class="fas fa-box fa-2x"></i>
          <div class="stat-value" id="waiting-delivery">0</div>
          <div class="stat-label">في انتظار التسليم</div>
        </div>
        <div class="stat-card in-transit">
          <i class="fas fa-truck-moving fa-2x"></i>
          <div class="stat-value" id="in-transit">0</div>
          <div class="stat-label">جاري التوصيل</div>
        </div>
      </div>
      <div class="controls">
        <button class="filter-btn" data-status="all" onclick="setFilterStatus('all')">
          <i class="fas fa-list"></i> جميع الطلبات
        </button>
        <button class="filter-btn active" data-status="في انتظار التسليم" onclick="setFilterStatus('في انتظار التسليم')">
          <i class="fas fa-box"></i> في انتظار التسليم
        </button>
        <button class="filter-btn" data-status="جاري التوصيل" onclick="setFilterStatus('جاري التوصيل')">
          <i class="fas fa-truck-moving"></i> جاري التوصيل
        </button>
        <button class="filter-btn" data-status="تم التوصيل" onclick="setFilterStatus('تم التوصيل')">
          <i class="fas fa-check"></i> تم التوصيل
        </button>
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الهاتف أو العنوان..." oninput="handleSearch()">
        </div>
      </div>
      <div class="orders-table-container">
        <table>
          <thead>
            <tr>
              <th>اسم المطعم</th>
              <th>عنوان التوصيل</th>
              <th>سعر التوصيل</th>
              <th>الكابتن</th>
              <th>العمولة</th>
              <th>الإجراءات</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="orders-body">
            <tr>
              <td colspan="7" class="loading-state">
                <div class="loading-spinner"></div>
                جارٍ تحميل الطلبات...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Modal for order details -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>تفاصيل الطلب</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-details">
      </div>
    </div>
  </div>
  <!-- Hidden audio for notifications -->
  <audio id="notification-sound" src="notification.mp3.mp3" preload="auto"></audio>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://vrngqopmdvdmdayswlos.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZybmdxb3BtZHZkbWRheXN3bG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4ODYwMDgsImV4cCI6MjA2NzQ2MjAwOH0.bDwUJkyiQfv1egMgYy-hrj8pJMGTHAeQYBdp0z4CMrs'
    );
    let currentStatusFilter = "في انتظار التسليم";
    let currentSearchText = "";
    let displayedOrders = [];
    let captains = [];
    let restaurants = [];
    const alertSound = document.getElementById("notification-sound");
    let audioAllowed = false;
    // تفعيل الصوت
    document.addEventListener("click", () => { audioAllowed = true; }, { once: true });
    // تحميل الكباتن
    async function loadCaptains() {
      const { data, error } = await supabase
        .from("users")
        .select("id, full_name")
        .eq("role", "captain");
      if (error) throw error;
      captains = data || [];
      populateCaptainSelects();
    }
    // تحميل المطاعم من جدول restaurants
    async function loadRestaurants() {
      const { data, error } = await supabase
        .from("restaurants")
        .select("id, restaurant_name");
      if (error) throw error;
      restaurants = data || [];
      populateRestaurantSelect();
      console.log("المطاعم المحملة من قاعدة البيانات:", restaurants);
    }
    // ملء قائمة المطاعم من جدول restaurants فقط
    function populateRestaurantSelect() {
      const select = document.getElementById("restaurant-select");
      if (!select) return;
      select.innerHTML = '<option value="">اختر مطعمًا</option>';
      restaurants.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.restaurant_name;
        select.appendChild(opt);
      });
    }
    // ملء قوائم الكباتن
    function populateCaptainSelects() {
      [document.getElementById("captain-select-new")].forEach(select => {
        if (!select) return;
        select.innerHTML = '<option value="">اختر كابتن</option>';
        captains.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.full_name;
          select.appendChild(opt);
        });
      });
    }
    // تحميل شعار المكتب
    async function loadOfficeLogo() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data: userData } = await supabase
        .from("users")
        .select("full_name")
        .eq("id", user.id)
        .single();
      const logoTitle = document.querySelector('.sidebar-logo h2');
      if (logoTitle) logoTitle.textContent = userData.full_name || "مكتب السريع";
    }
    // تحميل الإحصائيات
    async function loadStatistics() {
      const [total, delivered, waiting, inTransit] = await Promise.all([
        supabase.from("orders").select("id", { count: 'exact', head: true }),
        supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "تم التوصيل"),
        supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "في انتظار التسليم"),
        supabase.from("orders").select("id", { count: 'exact', head: true }).eq("status", "جاري التوصيل")
      ]);
      document.getElementById("total-orders").textContent = total.count || 0;
      document.getElementById("delivered").textContent = delivered.count || 0;
      document.getElementById("waiting-delivery").textContent = waiting.count || 0;
      document.getElementById("in-transit").textContent = inTransit.count || 0;
    }
    // عرض الطلبات
    async function fetchOrdersByStatus(status) {
      showLoadingState();
      let query = supabase
        .from("orders")
        .select("id, custom_name, custom_phone, custom_address, restaurant_id, captain_id, status, order_price, service_price, created_at, commission_percent")
        .order("created_at", { ascending: false });
      if (status !== "all") query = query.eq("status", status);
const { data: orders, error } = await query;      if (error) return showErrorState(error.message);
      let filtered = orders || [];
      if (currentSearchText) {
        filtered = filtered.filter(order => {
          const rest = restaurants.find(r => r.id === order.restaurant_id);
          const cap = captains.find(c => c.id === order.captain_id);
          const text = currentSearchText.toLowerCase();
          return (
            order.custom_name?.toLowerCase().includes(text) ||
            order.custom_phone?.includes(currentSearchText) ||
            order.custom_address?.toLowerCase().includes(text) ||
            rest?.restaurant_name?.toLowerCase().includes(text) ||
            cap?.full_name?.toLowerCase().includes(text)
          );
        });
      }
      displayedOrders = filtered;
      displayOrders(filtered);
    }
    function showLoadingState() {
      document.getElementById("orders-body").innerHTML = `
        <tr><td colspan="7" class="loading-state">جاري التحميل...</td></tr>`;
    }
    function showErrorState(msg) {
      document.getElementById("orders-body").innerHTML = `
        <tr><td colspan="7" class="loading-state" style="color:red;">❌ ${msg}</td></tr>`;
    }
    function generateCaptainOptions(selectedId) {
      return captains.map(c => `
        <option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.full_name}</option>
      `).join('');
    }
    window.handleCaptainChange = async function(orderId, captainId) {
      const select = document.getElementById(`captain-select-${orderId}`);
      const reassignBtn = document.getElementById(`reassign-btn-${orderId}`);
      const info = document.getElementById(`captain-info-${orderId}`);
      select.disabled = true;
      const { error } = await supabase
        .from("orders")
        .update({ captain_id: captainId })
        .eq("id", orderId);
      select.disabled = false;
      if (error) return alert("خطأ في التحديث");
      const cap = captains.find(c => c.id === captainId);
      if (captainId) {
        reassignBtn.disabled = false;
        reassignBtn.classList.replace('disabled', 'enabled');
        info.style.display = 'block';
        info.innerHTML = `<span class="captain-badge success">✓ ${cap?.full_name}</span>`;
      } else {
        reassignBtn.disabled = true;
        reassignBtn.classList.replace('enabled', 'disabled');
        info.style.display = 'none';
      }
    };
    function displayOrders(orders) {
      const tbody = document.getElementById("orders-body");
      tbody.innerHTML = "";
      if (!orders.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="loading-state">لا توجد طلبات</td></tr>`;
        return;
      }
      orders.forEach(order => {
        const restaurant = restaurants.find(r => r.id === order.restaurant_id);
        const row = document.createElement("tr");
        row.classList.add("order-row");
        row.dataset.orderId = order.id;
        if (order.status === "في انتظار التسليم") {
          row.innerHTML = `
            <td><strong>${restaurant?.restaurant_name || "مطعم غير محدد"}</strong></td>
            <td><input type="text" class="input-field" value="${order.custom_address}" onchange="updateAddress('${order.id}', this.value)"/></td>
            <td><span style="color:#f97316">${order.service_price} ج.م</span></td>
            <td>
              <div class="captain-select-container">
                <select class="select-field" id="captain-select-${order.id}" onchange="handleCaptainChange('${order.id}', this.value)">
                  <option value="">اختر كابتن</option>${generateCaptainOptions(order.captain_id)}
                </select>
                <div class="captain-info" id="captain-info-${order.id}" style="display: ${order.captain_id ? 'block' : 'none'}">
                  <span class="captain-badge success">✓ تم التعيين</span>
                </div>
              </div>
            </td>
            <td>${order.commission_percent || 0}%</td>
            <td>
              <button class="reassign-btn ${order.captain_id ? 'enabled' : 'disabled'}" id="reassign-btn-${order.id}" ${order.captain_id ? '' : 'disabled'} onclick="reassignCaptain('${order.id}', this)">إعادة تعيين</button>
              <button class="deliver-btn enabled" onclick="markAsDelivered('${order.id}', this)">تم التوصيل</button>
              <button class="details-btn" onclick='showOrderDetails(${JSON.stringify(order)})'>تفاصيل</button>
            </td>
            <td><button class="delete-btn" onclick="deleteOrder('${order.id}', this)">حذف</button></td>
          `;
        } else {
          const cap = captains.find(c => c.id === order.captain_id);
          row.innerHTML = `
            <td><strong>${restaurant?.restaurant_name || "مطعم غير محدد"}</strong></td>
            <td>${order.custom_address}</td>
            <td><span style="color:#f97316">${order.service_price} ج.م</span></td>
            <td><div class="captain-display"><span class="captain-name">${cap?.full_name || "غير محدد"}</span></div></td>
            <td>${order.commission_percent || 0}%</td>
            <td><span style="color:#059669;font-weight:600;">${order.status}</span> <button class="details-btn" onclick='showOrderDetails(${JSON.stringify(order)})'>تفاصيل</button></td>
            <td><button class="delete-btn" onclick="deleteOrder('${order.id}', this)">حذف</button></td>
          `;
        }
        tbody.appendChild(row);
      });
    }
    window.showOrderDetails = function(order) {
      const restaurant = restaurants.find(r => r.id === order.restaurant_id);
      const captain = captains.find(c => c.id === order.captain_id);
      
      // إنشاء عناصر DOM بشكل آمن بدلاً من innerHTML
      const modalDetails = document.getElementById("modal-details");
      modalDetails.innerHTML = ''; // مسح المحتوى السابق
      
      const createDetailParagraph = (label, value) => {
        const p = document.createElement('p');
        const strong = document.createElement('strong');
        strong.textContent = label;
        p.appendChild(strong);
        p.appendChild(document.createTextNode(' ' + (value || 'غير محدد')));
        return p;
      };
      
      modalDetails.appendChild(createDetailParagraph('اسم العميل:', order.custom_name));
      modalDetails.appendChild(createDetailParagraph('الهاتف:', order.custom_phone));
      modalDetails.appendChild(createDetailParagraph('العنوان:', order.custom_address));
      modalDetails.appendChild(createDetailParagraph('اسم المطعم:', restaurant?.restaurant_name));
      modalDetails.appendChild(createDetailParagraph('الكابتن:', captain?.full_name));
      modalDetails.appendChild(createDetailParagraph('الحالة:', order.status));
      modalDetails.appendChild(createDetailParagraph('سعر التوصيل:', order.service_price + ' ج.م'));
      modalDetails.appendChild(createDetailParagraph('نسبة العمولة من خدمة التوصيل:', (order.commission_percent || 0) + '%'));
      
      document.getElementById("modal").style.display = "flex";
    };
    window.closeModal = () => {
      document.getElementById("modal").style.display = "none";
    };
    // دوال التفاعل
    window.reassignCaptain = async (id, btn) => {
      const captainId = document.getElementById(`captain-select-${id}`).value;
      if (!captainId) return alert("اختر كابتن");
      btn.disabled = true;
      await supabase.from("orders").update({ captain_id: captainId }).eq("id", id);
      btn.disabled = false;
    };
    window.markAsDelivered = async (id, btn) => {
      btn.disabled = true;
      await supabase.from("orders").update({ status: "تم التوصيل" }).eq("id", id);
      loadStatistics();
      btn.parentElement.parentElement.remove();
    };
    window.updateAddress = async (id, addr) => {
      if (!addr.trim()) return alert("أدخل عنوان صحيح");
      await supabase.from("orders").update({ custom_address: addr }).eq("id", id);
    };
    window.deleteOrder = async (id, btn) => {
      if (!confirm("هل تريد حذف هذا الطلب؟")) return;
      btn.disabled = true;
      await supabase.from("orders").delete().eq("id", id);
      btn.parentElement.parentElement.remove();
      loadStatistics();
    };
    // التحكم في الفلاتر والبحث
    window.setFilterStatus = (status) => {
      currentStatusFilter = status;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-status="${status}"]`).classList.add('active');
      fetchOrdersByStatus(currentStatusFilter);
    };
    window.handleSearch = () => {
      currentSearchText = document.getElementById("searchInput").value.trim();
      fetchOrdersByStatus(currentStatusFilter);
    };
    // إضافة طلب يدويًا
    function toggleAddOrderForm() {
      const form = document.getElementById("add-order-form");
      form.style.display = form.style.display === "block" ? "none" : "block";
    }
    window.addManualOrder = async () => {
      const restaurantId = document.getElementById("restaurant-select").value;
      const address = document.getElementById("delivery-address").value;
      const servicePrice = document.getElementById("service-price").value;
      const commissionPercent = document.getElementById("commission-percent").value;
      const captainId = document.getElementById("captain-select-new").value;

      if (!restaurantId || !address || !servicePrice || !captainId) {
        return alert("يرجى تعبئة جميع الحقول المطلوبة");
      }

      // التحقق من أن المطعم مختار من القائمة المحلية
      if (!restaurants.some(r => r.id === restaurantId)) {
        console.error("الـ ID غير موجود في القائمة المحلية:", restaurantId);
        return alert("المطعم المحدد غير متوفر في القائمة الحالية. يرجى تحديث الصفحة.");
      }

      // التحقق من صحة البيانات الرقمية قبل الإدراج
      if (!isValidNumber(servicePrice) || parseFloat(servicePrice) <= 0) {
        return alert("يرجى إدخال سعر خدمة صحيح (أكبر من صفر)");
      }
      
      if (!isValidNumber(commissionPercent)) {
        return alert("يرجى إدخال نسبة عمولة صحيحة");
      }
      
      const validServicePrice = parseFloat(servicePrice);
      const validCommissionPercent = Math.max(0, Math.min(100, parseFloat(commissionPercent)));
      
      const { error } = await supabase
        .from("orders")
        .insert([{
          restaurant_id: restaurantId,
          custom_address: address,
          order_price: 0,
          service_price: validServicePrice,
          commission_percent: validCommissionPercent,
          captain_id: captainId,
          status: "في انتظار التسليم"
        }]);
        
      // دالة مساعدة للتحقق من صحة الأرقام
      function isValidNumber(value) {
        return value !== null && value !== undefined && value !== '' && !isNaN(value) && !isNaN(parseFloat(value));
      }
        
      if (error) {
        console.error("Error details:", error);
        return alert("خطأ في الإضافة: " + error.message);
      }
      
      showSuccess("تم إضافة الطلب بنجاح");
      toggleAddOrderForm();
      document.getElementById("restaurant-select").value = "";
      document.getElementById("delivery-address").value = "";
      document.getElementById("service-price").value = "";
      document.getElementById("commission-percent").value = "20";
      document.getElementById("captain-select-new").value = "";
      
      loadStatistics();
      fetchOrdersByStatus(currentStatusFilter);
    };
    window.logout = async () => {
      await supabase.auth.signOut();
      window.location.href = './index.html';
    };
    // بدء التشغيل
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return window.location.href = './index.html';
      await Promise.all([loadCaptains(), loadRestaurants(), loadOfficeLogo()]);
      await Promise.all([loadStatistics(), fetchOrdersByStatus(currentStatusFilter)]);
      // تحديث تلقائي كل 10 ثواني مع تنظيف مناسب
      let dashboardUpdateInterval = setInterval(() => {
        loadStatistics();
        fetchOrdersByStatus(currentStatusFilter);
      }, 10000);
      
      // تنظيف الـ interval عند مغادرة الصفحة لمنع تسريب الذاكرة
      window.addEventListener('beforeunload', () => {
        if (dashboardUpdateInterval) {
          clearInterval(dashboardUpdateInterval);
          dashboardUpdateInterval = null;
        }
      });
      
      // إيقاف التحديثات عند إخفاء الصفحة وإعادة تشغيلها عند العودة
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && dashboardUpdateInterval) {
          clearInterval(dashboardUpdateInterval);
          dashboardUpdateInterval = null;
        } else if (!document.hidden && !dashboardUpdateInterval) {
          dashboardUpdateInterval = setInterval(() => {
            loadStatistics();
            fetchOrdersByStatus(currentStatusFilter);
          }, 10000);
        }
      });
    }
    // إشعارات
    function showSuccess(msg) {
      const notif = document.createElement("div");
      notif.className = "notification notification-success";
      notif.textContent = msg;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }
    init();
    // فتح/إغلاق نموذج إضافة طلب
    window.toggleAddOrderForm = function () {
      const form = document.getElementById("add-order-form");
      if (form.style.display === "block") {
        form.style.display = "none";
      } else {
        form.style.display = "block";
      }
    };
  </script>
</body>
</html>