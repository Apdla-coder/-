<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تقرير أداء الكباتن</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="bar.css">
  <style>
    :root {
      --primary: #f97316;
      --primary-dark: #ea580c;
      --secondary: #3b82f6;
      --secondary-dark: #2563eb;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --info: #0ea5e9;
      --info-dark: #0284c7;
      --dark: #1f2937;
      --darker: #111827;
      --light: #f3f4f6;
      --lighter: #f9fafb;
      --gray: #6b7280;
      --gray-light: #9ca3af;
      --border: #e5e7eb;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f7fa;
      color: var(--darker);
      direction: rtl;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header h1 {
      color: var(--darker);
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    .search-container {
      position: relative;
      max-width: 300px;
      width: 100%;
    }
    
    .search-container i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .search-input {
      width: 100%;
      padding: 0.8rem 2.5rem 0.8rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: white;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 4px 12px var(--shadow);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 0.9rem;
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 1rem;
    }
    
    .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--darker);
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .filter-btn:hover:not(.active) {
      background: var(--light);
    }
    
    /* Captains Grid */
    .captains-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .captain-card {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }
    
    .captain-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px var(--shadow);
    }
    
    .captain-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      color: white;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .captain-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .captain-info {
      flex: 1;
    }
    
    .captain-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
    }
    
    .captain-status {
      font-size: 0.8rem;
      opacity: 0.9;
      margin: 0;
    }
    
    .captain-body {
      padding: 1.5rem;
    }
    
    .captain-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 0.25rem;
    }
    
    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--darker);
    }
    
    .performance-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.7rem;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    
    .performance-excellent {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .performance-good {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }
    
    .performance-average {
      background: rgba(249, 115, 22, 0.15);
      color: var(--primary);
    }
    
    .performance-poor {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }
    
    .captain-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: var(--secondary-dark);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: var(--success-dark);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: var(--danger-dark);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--dark);
    }
    
    .btn-outline:hover {
      background: var(--light);
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 1rem;
    }
    
    .modal-content {
      background: white;
      border-radius: 1rem;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--darker);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .close-btn:hover {
      background: var(--light);
      color: var(--dark);
    }
    
    .form-group {
      margin-bottom: 1.2rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: var(--lighter);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    
    .form-row {
      display: flex;
      gap: 1rem;
    }
    
    .form-row > div {
      flex: 1;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
    }
    
    /* Captain Details Modal */
    .captain-details-modal .modal-content {
      max-width: 800px;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin: 1.5rem 0;
    }
    
    .captain-details-tab {
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .captain-details-tab.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
    }
    
    .tab-content {
      padding: 1rem 0;
    }
    
    .orders-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-info {
      flex: 1;
    }
    
    .order-status {
      padding: 0.2rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .status-warning {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }
    
    .status-danger {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }
    
    .status-info {
      background: rgba(249, 115, 22, 0.15);
      color: var(--primary);
    }
    
    .order-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th {
      text-align: right;
      padding: 0.75rem;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 1px solid var(--border);
    }
    
    .table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    
    .pagination button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: var(--light);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
    }
    
    .spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--gray-light);
    }
    
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--dark);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.error {
      background: var(--danger);
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        border-left: none;
        border-bottom: 1px solid var(--border);
        padding: 1rem;
      }
      
      .main-content {
        padding: 1.5rem;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .captains-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <img src="./logo.png" alt="شعار المكتب">
        <h2>المكتب</h2>
      </div>
      <a class="nav-link active" href="./dashboard.html">
        <i class="fas fa-tachometer-alt"></i>
        <span>لوحة التحكم</span>
      </a>
      <a class="nav-link" href="./add-order.html">
        <i class="fas fa-plus-circle"></i>
        <span>اضافة طلب يدويا</span>
      </a>
      <a class="nav-link" href="./customers.html">
        <i class="fas fa-users"></i>
        <span>إدارة المستخدمين</span>
      </a>
      <a class="nav-link" href="./restaurant-management.html">
        <i class="fas fa-utensils"></i>
        <span>إدارة المطاعم</span>
      </a>
      <a class="nav-link" href="./covenant.html">
        <i class="fas fa-handshake"></i>
        <span>نظام العهدة</span>
      </a>
      <a class="nav-link" href="./captain-preformans.html">
        <i class="fas fa-chart-line"></i>
        <span>أداء الكباتن</span>
      </a>
      <a class="nav-link" href="./history-mange.html">
        <i class="fas fa-history"></i>
        <span>سجل الطلبات</span>
      </a>
      <a class="nav-link" href="./index.html">
        <i class="fas fa-history"></i>
        <span> تسجيل الخروج</span>
      </a>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
        <h1>أداء الكباتن اليوم</h1>
        <div class="search-container">
          <input type="text" id="search-input" class="search-input" placeholder="بحث عن كابتن..." />
          <i class="fas fa-search"></i>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>إجمالي الكباتن</h3>
          <div class="value" id="total-captains">0</div>
        </div>
        <div class="stat-card">
          <h3>إجمالي الطلبات</h3>
          <div class="value" id="total-orders">0</div>
        </div>
        <div class="stat-card">
          <h3>تم التوصيل</h3>
          <div class="value" id="delivered-orders">0</div>
        </div>
        <div class="stat-card">
          <h3>إجمالي العمولة</h3>
          <div class="value" id="total-commission">0.00 جنيه</div>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active" data-filter="all">الكل</button>
        <button class="filter-btn" data-filter="free">فاضي</button>
        <button class="filter-btn" data-filter="busy">مشغول</button>
        <button class="filter-btn" data-filter="high-performance">أداء عالي</button>
      </div>
      
      <!-- Captains List -->
      <div class="captains-grid" id="captains-container"></div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  
  <!-- Withdraw Modal -->
  <div class="modal" id="withdraw-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>سحب عمولة الكابتن</h2>
        <button class="close-btn" id="close-withdraw-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>اسم الكابتن</label>
          <input type="text" id="captain-name" class="form-control" disabled />
        </div>
        <div class="form-group">
          <label>العمولة المتاحة</label>
          <input type="text" id="available-commission" class="form-control" disabled />
        </div>
        <div class="form-group">
          <label>مبلغ السحب (جنيه)</label>
          <input type="number" id="withdraw-amount" class="form-control" step="0.01" min="0" />
        </div>
        <div class="form-group">
          <label>ملاحظات (اختياري)</label>
          <textarea id="withdraw-notes" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-withdraw">إلغاء</button>
        <button class="btn btn-primary" id="confirm-withdraw">تأكيد السحب</button>
      </div>
    </div>
  </div>
  
  <!-- Captain Details Modal -->
  <div class="modal captain-details-modal" id="captain-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>تفاصيل الكابتن</h2>
        <button class="close-btn" id="close-details-btn">&times;</button>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="captain-details-tab active" data-tab="overview">ملخص</div>
        <div class="captain-details-tab" data-tab="orders">الطلبات</div>
        <div class="captain-details-tab" data-tab="history">سجل السحب</div>
      </div>
      
      <!-- Overview Tab -->
      <div class="tab-content" id="tab-overview" style="display: block;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <p><strong>الاسم:</strong> <span id="details-captain-name"></span></p>
            <p><strong>الهاتف:</strong> <span id="details-captain-phone"></span></p>
            <p><strong>تاريخ الانضمام:</strong> <span id="details-captain-joined"></span></p>
          </div>
          <div>
            <p><strong>إجمالي الطلبات:</strong> <span id="details-total-orders"></span></p>
            <p><strong>تم التوصيل:</strong> <span id="details-delivered"></span></p>
            <p><strong>جاري التوصيل:</strong> <span id="details-pending"></span></p>
            <p><strong>فشل التوصيل:</strong> <span id="details-failed"></span></p>
            <p><strong>إجمالي العمولة:</strong> <span id="details-total-commission"></span></p>
            <p><strong>المستلم:</strong> <span id="details-withdrawn"></span></p>
          </div>
        </div>
      </div>
      
      <!-- Orders Tab -->
      <div class="tab-content" id="tab-orders" style="display: none;">
        <h3>آخر 5 طلبات</h3>
        <div class="orders-list" id="orders-list"></div>
      </div>
      
      <!-- History Tab -->
      <div class="tab-content" id="tab-history" style="display: none;">
        <h3>سجل السحب</h3>
        <table class="table">
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>المبلغ</th>
              <th>الحالة</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody id="withdrawals-history"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toast-message"></span>
  </div>
  

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://vrngqopmdvdmdayswlos.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZybmdxb3BtZHZkbWRheXN3bG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4ODYwMDgsImV4cCI6MjA2NzQ2MjAwOH0.bDwUJkyiQfv1egMgYy-hrj8pJMGTHAeQYBdp0z4CMrs'
    );
    // DOM Elements
    const searchInput = document.getElementById('search-input');
    const captainsContainer = document.getElementById('captains-container');
    const paginationElement = document.getElementById('pagination');
    const captainDetailsModal = document.getElementById('captain-details-modal');
    const closeDetailsBtn = document.getElementById('close-details-btn');
    const toast = document.getElementById('toast');
    const filterButtons = document.querySelectorAll('.filter-btn');
    // State
    let captainsData = [];
    let filteredData = [];
    let selectedCaptain = null;
    let currentPage = 1;
    const itemsPerPage = 8;
    // Load office logo
    async function loadOfficeLogo() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const { data: userData } = await supabase
          .from("users")
          .select("full_name")
          .eq("id", user.id)
          .single();
        const logoTitle = document.querySelector('.sidebar-logo h2');
        if (logoTitle && userData?.full_name) {
          logoTitle.textContent = userData.full_name;
        }
      } catch (err) {
        console.warn("Failed to load office logo:", err.message);
      }
    }
    // Debounce
    const debounce = (func, wait) => {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    };
    // Search
    const handleSearch = debounce(() => {
      const term = searchInput?.value?.toLowerCase().trim() || '';
      filteredData = term
        ? captainsData.filter(c => c.full_name.toLowerCase().includes(term))
        : [...captainsData];
      applyFilter(selectedFilter);
      currentPage = 1;
      renderCaptains();
      renderPagination();
    }, 300);
    // Filter
    let selectedFilter = 'all';
    function applyFilter(filter) {
      selectedFilter = filter;
      filterButtons.forEach(btn => {
        if (btn) {
          btn.classList.toggle('active', btn.dataset.filter === filter);
        }
      });
      currentPage = 1;
      let data = [...captainsData];
      switch (filter) {
        case 'busy':
          data = data.filter(c => c.status === 'مشغول');
          break;
        case 'free':
          data = data.filter(c => c.status === 'فاضي');
          break;
        case 'high-performance':
          data = data.filter(c => c.performance_score >= 60);
          break;
      }
      const term = searchInput?.value?.toLowerCase().trim() || '';
      if (term) {
        data = data.filter(c => c.full_name.toLowerCase().includes(term));
      }
      filteredData = data;
      renderCaptains();
      renderPagination();
    }
    // Load Data
    async function loadTodayData() {
      try {
        if (captainsContainer) {
          captainsContainer.innerHTML = `<div class="loading"><div class="spinner"></div><p>جارٍ التحميل...</p></div>`;
        }
        const today = new Date();
        const todayStart = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const todayEnd = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        const [{ data: captains }, { data: orders }] = await Promise.all([
          supabase.from("users").select("id, full_name, phone, created_at, total_withdrawn").eq("role", "captain"),
          supabase.from("orders")
            .select("*")
            .not("captain_id", "is", null)
            .gte('created_at', todayStart)
            .lt('created_at', todayEnd)
        ]);
        if (!captains) throw new Error("فشل تحميل الكباتن");
        if (!orders) throw new Error("فشل تحميل الطلبات");
        const captainStats = new Map();
        const captainOrders = new Map();
        captains.forEach(c => {
          captainStats.set(c.id, {
            id: c.id,
            full_name: c.full_name,
            phone: c.phone,
            created_at: c.created_at,
            total_withdrawn: parseFloat(c.total_withdrawn) || 0,
            total_orders: 0,
            delivered: 0,
            pending: 0,
            failed: 0,
            distributing: 0,
            total_order_price: 0,
            total_service_price: 0,
            office_profit: 0,
            captain_earning: 0,
            status: "فاضي",
            performance_score: 0,
            recent_orders: []
          });
        });
        orders.forEach(order => {
          const stats = captainStats.get(order.captain_id);
          if (!stats) return;
          stats.total_orders++;
          stats.total_order_price += parseFloat(order.order_price) || 0;
          stats.total_service_price += parseFloat(order.service_price) || 0;
          const servicePrice = parseFloat(order.service_price) || 0;
          const commissionPercent = parseFloat(order.commission_percent) || 0;
          // المكتب يأخذ النسبة المئوية من سعر الخدمة
          const officeProfit = servicePrice * commissionPercent / 100;
          // الكابتن يأخذ الباقي من سعر الخدمة
          const captainEarning = servicePrice - officeProfit;
          stats.office_profit += officeProfit;
          stats.captain_earning += captainEarning;
          if (!captainOrders.has(order.captain_id)) {
            captainOrders.set(order.captain_id, []);
          }
          captainOrders.get(order.captain_id).push(order);
          switch (order.status) {
            case 'تم التوصيل':
              stats.delivered++;
              break;
            case 'جاري التوصيل':
              stats.pending++;
              stats.status = "مشغول";
              break;
            case 'فشل التوصيل':
              stats.failed++;
              break;
            case 'قيد التوزيع':
              stats.distributing++;
              break;
          }
        });
captainsData = Array.from(captainStats.values()).map(captain => {
  const deliveryRate = captain.total_orders > 0 ? (captain.delivered / captain.total_orders) * 100 : 0;
  const completionRate = captain.total_orders > 0 ? ((captain.delivered + captain.pending) / captain.total_orders) * 100 : 0;
  const performanceScore = (deliveryRate * 0.6) + (completionRate * 0.4);

  // هنا بيتحسب الربح المتبقي للمكتب بعد الخصم
  const netOfficeProfit = captain.office_profit - captain.total_withdrawn;

  return {
    ...captain,
    performance_score: Math.round(performanceScore),
    office_profit: Math.max(0, parseFloat(netOfficeProfit.toFixed(2))), // للتأكد من إنه مش بالسالب
    recent_orders: (captainOrders.get(captain.id) || [])
      .filter(Boolean)
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .slice(0, 5)
  };
});
        captainsData.sort((a, b) => b.performance_score - a.performance_score);
        updateStats(
          captains.length,
          orders.length,
          orders.filter(o => o.status === 'تم التوصيل').length,
          captainsData.reduce((sum, c) => sum + c.office_profit, 0)
        );
        filteredData = [...captainsData];
        applyFilter('all');
        renderCaptains();
        renderPagination();
      } catch (error) {
        console.error('Error:', error);
        if (captainsContainer) {
          captainsContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>خطأ في التحميل</h3>
              <p>${error.message || 'تحقق من الاتصال'}</p>
            </div>`;
        }
      }
    }
    // Render Captains
    function renderCaptains() {
      if (!captainsContainer) return;
      captainsContainer.innerHTML = "";
      if (filteredData.length === 0) {
        captainsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>لا توجد نتائج</h3>
            <p>حاول تغيير معايير البحث أو الفلاتر</p>
          </div>`;
        return;
      }
      const start = (currentPage - 1) * itemsPerPage;
      const end = Math.min(start + itemsPerPage, filteredData.length);
      for (let i = start; i < end; i++) {
        const c = filteredData[i];
        const perf = c.performance_score >= 80 ? "excellent" :
                     c.performance_score >= 60 ? "good" :
                     c.performance_score >= 40 ? "average" : "poor";
        const perfText = { 
          excellent: "ممتاز", 
          good: "جيد", 
          average: "متوسط", 
          poor: "ضعيف" 
        }[perf];
        const card = document.createElement("div");
        card.className = "captain-card";
        card.innerHTML = `
          <div class="captain-header">
            <div class="captain-avatar"><i class="fas fa-user"></i></div>
            <div class="captain-info">
              <h3 class="captain-name">${c.full_name}</h3>
              <p class="captain-status"><i class="fas fa-circle fa-xs" style="color:${c.status === 'مشغول' ? '#ef4444' : '#10b981'};"></i> ${c.status}</p>
            </div>
          </div>
          <div class="captain-body">
            <div class="captain-stats">
              <div class="stat-item">
                <div class="stat-label">إجمالي</div>
                <div class="stat-value">${c.total_orders}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">تم التوصيل</div>
                <div class="stat-value">${c.delivered}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">جاري التوصيل</div>
                <div class="stat-value">${c.pending}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">فشل</div>
                <div class="stat-value">${c.failed}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ربح المكتب</div>
                <div class="stat-value">${c.office_profit.toFixed(2)} جنيه</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ربح الكابتن</div>
                <div class="stat-value">${c.captain_earning.toFixed(2)} جنيه</div>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:1rem 0;">
              <span class="performance-badge performance-${perf}">${perfText}</span>
              <small style="color:var(--gray)">أداء: ${c.performance_score}%</small>
            </div>
            <div class="captain-actions">
              <button class="btn btn-primary view-details-btn" data-id="${c.id}"><i class="fas fa-eye"></i> تفاصيل</button>
              <button class="btn btn-danger clear-btn" data-id="${c.id}"><i class="fas fa-trash"></i> تصفيه</button>
            </div>
          </div>`;
        captainsContainer.appendChild(card);
      }
      attachEventListeners();
    }
    function attachEventListeners() {
      const clearButtons = document.querySelectorAll('.clear-btn');
      if (clearButtons.length > 0) {
        clearButtons.forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id');
            selectedCaptain = captainsData.find(c => c.id === id);
            if (selectedCaptain) {
              if (confirm(`هل أنت متأكد من تصفيه ربح المكتب للكابتن ${selectedCaptain.full_name}؟`)) {
                await handleClear(id);
              }
            }
          };
        });
      }
      const viewDetailsButtons = document.querySelectorAll('.view-details-btn');
      if (viewDetailsButtons.length > 0) {
        viewDetailsButtons.forEach(btn => {
          btn.onclick = () => {
            const id = btn.getAttribute('data-id');
            selectedCaptain = captainsData.find(c => c.id === id);
            if (selectedCaptain) showCaptainDetails(selectedCaptain);
          };
        });
      }
    }
    function renderPagination() {
      if (!paginationElement) return;
      paginationElement.innerHTML = "";
      if (filteredData.length <= itemsPerPage) return;
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const maxVisible = 5;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = Math.min(totalPages, start + maxVisible - 1);
      if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);
      const prev = document.createElement("button");
      prev.innerHTML = '<i class="fas fa-chevron-right"></i>';
      prev.disabled = currentPage === 1;
      prev.onclick = () => { 
        if (currentPage > 1) { 
          currentPage--; 
          renderCaptains(); 
          renderPagination(); 
        } 
      };
      paginationElement.appendChild(prev);
      if (start > 1) {
        const first = createPageButton(1);
        paginationElement.appendChild(first);
        if (start > 2) addEllipsis();
      }
      for (let i = start; i <= end; i++) {
        paginationElement.appendChild(createPageButton(i, i === currentPage));
      }
      if (end < totalPages) {
        if (end < totalPages - 1) addEllipsis();
        const last = createPageButton(totalPages);
        paginationElement.appendChild(last);
      }
      const next = document.createElement("button");
      next.innerHTML = '<i class="fas fa-chevron-left"></i>';
      next.disabled = currentPage === totalPages;
      next.onclick = () => { 
        if (currentPage < totalPages) { 
          currentPage++; 
          renderCaptains(); 
          renderPagination(); 
        } 
      };
      paginationElement.appendChild(next);
    }
    function createPageButton(page, active = false) {
      const btn = document.createElement("button");
      btn.textContent = page;
      if (active) btn.classList.add("active");
      btn.onclick = () => { currentPage = page; renderCaptains(); renderPagination(); };
      return btn;
    }
    function addEllipsis() {
      const span = document.createElement("span");
      span.textContent = "...";
      span.style.padding = "0.5rem";
      return paginationElement.appendChild(span);
    }
    function updateStats(total, orders, delivered, commission) {
      const totalCaptains = document.getElementById("total-captains");
      const totalOrders = document.getElementById("total-orders");
      const deliveredOrders = document.getElementById("delivered-orders");
      const totalCommission = document.getElementById("total-commission");
      if (totalCaptains) totalCaptains.textContent = total;
      if (totalOrders) totalOrders.textContent = orders;
      if (deliveredOrders) deliveredOrders.textContent = delivered;
      if (totalCommission) totalCommission.textContent = `${commission.toFixed(2)} جنيه`;
    }
    function showCaptainDetails(captain) {
      if (!captain) return showToast("الكابتن غير موجود", "error");
      const detailsCaptainName = document.getElementById('details-captain-name');
      const detailsCaptainPhone = document.getElementById('details-captain-phone');
      const detailsCaptainJoined = document.getElementById('details-captain-joined');
      const detailsTotalOrders = document.getElementById('details-total-orders');
      const detailsDelivered = document.getElementById('details-delivered');
      const detailsPending = document.getElementById('details-pending');
      const detailsFailed = document.getElementById('details-failed');
      const detailsTotalCommission = document.getElementById('details-total-commission');
      const detailsWithdrawn = document.getElementById('details-withdrawn');
      if (detailsCaptainName) detailsCaptainName.textContent = captain.full_name;
      if (detailsCaptainPhone) detailsCaptainPhone.textContent = captain.phone || 'غير متوفر';
      if (detailsCaptainJoined) detailsCaptainJoined.textContent = new Date(captain.created_at).toLocaleDateString('ar-EG');
      if (detailsTotalOrders) detailsTotalOrders.textContent = captain.total_orders;
      if (detailsDelivered) detailsDelivered.textContent = captain.delivered;
      if (detailsPending) detailsPending.textContent = captain.pending;
      if (detailsFailed) detailsFailed.textContent = captain.failed;
      if (detailsTotalCommission) detailsTotalCommission.textContent = `${captain.office_profit.toFixed(2)} جنيه`;
      if (detailsWithdrawn) detailsWithdrawn.textContent = `${captain.total_withdrawn.toFixed(2)} جنيه`;
      const ordersList = document.getElementById('orders-list');
      if (ordersList) {
        ordersList.innerHTML = '';
        if (captain.recent_orders.length === 0 || !captain.recent_orders.some(Boolean)) {
          ordersList.innerHTML = '<p style="text-align:center;color:var(--gray);padding:1rem;">لا توجد طلبات</p>';
        } else {
          captain.recent_orders.filter(Boolean).forEach(order => {
            const statusClass = order.status === 'تم التوصيل' ? 'success' :
                                order.status === 'جاري التوصيل' ? 'warning' :
                                order.status === 'فشل التوصيل' ? 'danger' : 'info';
            const item = document.createElement('div');
            item.className = 'order-item';
            item.innerHTML = `
              <div class="order-info">
                <div>${(order.order_price ? parseFloat(order.order_price).toFixed(2) : '0.00')} جنيه</div>
                <small>${(order.service_price ? parseFloat(order.service_price).toFixed(2) : '0.00')} (الخدمة)</small>
              </div>
              <div class="order-status status-${statusClass}">${order.status}</div>
              <div class="order-actions">
                <button class="btn btn-sm btn-outline view-order-btn" data-id="${order.id}">
                  <i class="fas fa-eye"></i>
                </button>
              </div>`;
            ordersList.appendChild(item);
          });
          // Delegate view order click
          const viewOrderButtons = ordersList.querySelectorAll('.view-order-btn');
          if (viewOrderButtons.length > 0) {
            viewOrderButtons.forEach(btn => {
              btn.onclick = (e) => {
                e.stopPropagation();
                const orderId = btn.getAttribute('data-id');
                window.showOrderDetails(orderId);
              };
            });
          }
        }
      }
      fetchWithdrawalsHistory(captain.id);
      if (captainDetailsModal) captainDetailsModal.style.display = 'flex';
    }
    async function fetchWithdrawalsHistory(captainId) {
      try {
        const { data, error } = await supabase
          .from('captain_withdrawals')
          .select('*')
          .eq('captain_id', captainId)
          .order('created_at', { ascending: false })
          .limit(10);
        if (error) throw error;
        const body = document.getElementById('withdrawals-history');
        if (!body) return;
        body.innerHTML = '';
        if (data.length === 0) {
          body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--gray);">لا توجد عمليات</td></tr>`;
        } else {
          data.forEach(w => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(w.created_at).toLocaleDateString('ar-EG')}</td>
              <td>${w.amount.toFixed(2)} جنيه</td>
              <td><span class="status-badge status-success">تم السحب</span></td>
              <td>${w.notes || '-'}</td>`;
            body.appendChild(tr);
          });
        }
      } catch (err) {
        console.error("Fetch history error:", err);
        const body = document.getElementById('withdrawals-history');
        if (body) {
          body.innerHTML = `<tr><td colspan="4" style="color:var(--danger);">خطأ</td></tr>`;
        }
      }
    }
    function setupTabSwitching() {
      const tabButtons = document.querySelectorAll('.captain-details-tab');
      if (tabButtons.length > 0) {
        tabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            tabButtons.forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            btn.classList.add('active');
            const tabContent = document.getElementById(`tab-${tab}`);
            if (tabContent) tabContent.style.display = 'block';
          });
        });
      }
    }
    function showToast(message, type = 'success') {
      const msg = document.getElementById('toast-message');
      if (msg) {
        msg.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        setTimeout(() => {
          if (toast) toast.classList.remove('show');
        }, 5000);
      }
    }
    async function handleClear(captainId) {
      try {
        // إيجاد الكابتن في البيانات الحالية
        const captain = captainsData.find(c => c.id === captainId);
        if (!captain) throw new Error("الكابتن غير موجود");
        
        // التحقق من أن هناك ربح للمكتب
        if (captain.office_profit <= 0) {
          showToast("لا يوجد ربح للمكتب للتصفيّة", "warning");
          return;
        }
        
        // إنشاء سجل تصفيّة في جدول السحوبات
        const { error: insertErr } = await supabase.from('captain_withdrawals').insert([{
          captain_id: captainId,
          amount: captain.office_profit,
          notes: 'تصفيّة ربح المكتب',
          created_at: new Date().toISOString(),
          withdrawal_date: new Date().toISOString().split('T')[0]
        }]);
        
        if (insertErr) throw insertErr;
        
        // تحديث إجمالي السحوبات للكابتن
const { error: updateErr } = await supabase.from('users')
  .update({
    total_withdrawn: captain.total_withdrawn + captain.office_profit,
  })
  .eq('id', captainId);
console.log("تحديث total_withdrawn إلى:", captain.total_withdrawn + captain.office_profit);

        if (updateErr) throw updateErr;
        
        // تحديث بيانات الكابتن في الواجهة مباشرة
        const captainIndex = captainsData.findIndex(c => c.id === captainId);
        if (captainIndex !== -1) {
          // حفظ القيمة القديمة للربح
          const oldOfficeProfit = captainsData[captainIndex].office_profit;
          
          // تحديث بيانات الكابتن
          captainsData[captainIndex].office_profit = 0;
          captainsData[captainIndex].total_withdrawn += oldOfficeProfit;
        }
        
        // تحديث البيانات المفلترة
        const filteredIndex = filteredData.findIndex(c => c.id === captainId);
        if (filteredIndex !== -1) {
          filteredData[filteredIndex].office_profit = 0;
          filteredData[filteredIndex].total_withdrawn += captain.total_withdrawn;
        }
        
        // تحديث الإحصائيات
        const totalCommission = captainsData.reduce((sum, c) => sum + c.office_profit, 0);
        updateStats(
          captainsData.length,
          captainsData.reduce((sum, c) => sum + c.total_orders, 0),
          captainsData.reduce((sum, c) => sum + c.delivered, 0),
          totalCommission
        );
        
        // تحديث العرض
        renderCaptains();
        renderPagination();
        
   // تحديث بيانات الكابتن المختار قبل عرض التفاصيل
const updatedCaptain = captainsData.find(c => c.id === captainId);
if (captainDetailsModal && captainDetailsModal.style.display === 'flex') {
  showCaptainDetails(updatedCaptain); // عرض النسخة الحديثة
}

        
        showToast('تم تصفيّة ربح المكتب بنجاح');
        
      } catch (err) {
        console.error('Clear error:', err);
        showToast('خطأ في التصفية', 'error');
      }
    }
    // Events
    document.addEventListener("DOMContentLoaded", async () => {
      await loadOfficeLogo();
      await loadTodayData();
      setupTabSwitching();
    });
    if (searchInput) {
      searchInput.addEventListener('input', handleSearch);
    }
    if (filterButtons && filterButtons.length > 0) {
      filterButtons.forEach(btn => {
        if (btn) {
          btn.addEventListener('click', () => applyFilter(btn.dataset.filter));
        }
      });
    }
    if (closeDetailsBtn) {
      closeDetailsBtn.addEventListener('click', () => {
        if (captainDetailsModal) captainDetailsModal.style.display = 'none';
      });
    }
    window.addEventListener('click', e => {
      if (captainDetailsModal && e.target === captainDetailsModal) {
        captainDetailsModal.style.display = 'none';
      }
    });
    window.showOrderDetails = (id) => showToast(`عرض الطلب #${id}`);
    window.logout = () => confirm('تسجيل الخروج؟') && showToast('تم الخروج');
    // Auto-refresh
    setInterval(loadTodayData, 5 * 60 * 1000);
  </script>
  
</body>
</html>